<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador Zodíaco Chino</title>
    <style>
        /* Mantener los estilos CSS anteriores */
        :root {
            --primary: #2c3e50;
            --secondary: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f8f9fa;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* ... (otros estilos iguales) ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Calculador Zodíaco Chino</h1>
        <form id="zodiacForm">
            <div class="input-group">
                <input type="date" id="birthdate" required>
                <button type="button" id="calculateBtn">Calcular</button>
            </div>
        </form>
        <div class="result" id="result">
            <h2 id="zodiac-title"></h2>
            <div class="zodiac-info">
                <div>
                    <p><strong>Año de:</strong> <span id="zodiac-animal"></span></p>
                    <p><strong>Nombre Chino:</strong> <span id="zodiac-chinese"></span></p>
                </div>
                <div class="compatibility">
                    <p><strong>Mejores compatibilidades:</strong> <span id="best-matches"></span></p>
                    <p><strong>Compatibilidades buenas:</strong> <span id="good-matches"></span></p>
                    <p><strong>Evitar:</strong> <span id="avoid-matches"></span></p>
                </div>
            </div>
        </div>
    </div>
     </div>
        <div id="errorMsg" style="color: red; display: none; margin-top: 1rem;"></div>
    </div>

    <script>
        // 1. Sistema de almacenamiento y caché
        const STORAGE_KEY = 'chineseNewYearsData';
        let chineseNewYears = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

        // 2. Base de datos extendida (1900-2100)
        const initializeDatabase = () => {
            const presetDates = {
                // Lista completa en https://www.prokerala.com/general/calendar/chinese-new-year/
                1900: '1900-01-31', 1997: '1997-02-07', 2000: '2000-02-05',
                2022: '2022-02-01', 2023: '2023-01-22', 2024: '2024-02-10',
                2025: '2025-01-29', 2040: '2040-02-12', 2050: '2050-02-17',
                2100: '2100-02-14'
            };
            
            chineseNewYears = {...presetDates, ...chineseNewYears};
            localStorage.setItem(STORAGE_KEY, JSON.stringify(chineseNewYears));
        };

        // 3. Sistema de auto-actualización
        const estimateChineseNewYear = (year) => {
            // Algoritmo aproximado basado en ciclos lunares
            const baseDate = new Date(year, 0, 21);
            const cycle = (year - 1900) % 19;
            const estimation = new Date(baseDate.setDate(21 + cycle));
            
            // Ajuste final entre enero 21 - febrero 20
            return estimation.getMonth() === 0 ? 
                new Date(year, 0, Math.min(estimation.getDate(), 31)) :
                new Date(year, 1, Math.min(estimation.getDate(), 20));
        };

        // 4. Datos del zodíaco mejorados
        const zodiacData = [
            { animal: 'Rata', chinese: '鼠 (Shǔ)', best: ['Dragón', 'Mono'], good: ['Buey', 'Tigre', 'Conejo', 'Serpiente', 'Perro', 'Cerdo'], avoid: ['Caballo', 'Cabra'] },
            { animal: 'Buey', chinese: '牛 (Niú)', best: ['Serpiente', 'Gallo'], good: ['Rata', 'Tigre', 'Conejo', 'Dragón', 'Mono', 'Cerdo'], avoid: ['Cabra', 'Caballo', 'Perro'] },
            // ... (completar otros 10 animales)
        ];

        // 5. Núcleo de cálculo mejorado
        const getZodiac = (date) => {
            const year = date.getFullYear();
            
            // Validación de año soportado
            if(year < 1900 || year > 2100) {
                throw new Error('Año fuera de rango (1900-2100)');
            }

            // Obtener o estimar año nuevo chino
            let cnDate = chineseNewYears[year] ? 
                new Date(chineseNewYears[year]) : 
                estimateChineseNewYear(year);

            // Actualizar caché si usamos estimación
            if(!chineseNewYears[year]) {
                chineseNewYears[year] = cnDate.toISOString().split('T')[0];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chineseNewYears));
            }

            // Calcular año zodiacal
            const zodiacYear = date < cnDate ? year - 1 : year;
            const zodiacIndex = ((zodiacYear - 1900) % 12 + 12) % 12;
            
            return {
                ...zodiacData[zodiacIndex],
                exactDate: !!chineseNewYears[year]
            };
        };

        // 6. Interfaz de usuario mejorada
        const showError = (message) => {
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('errorMsg').textContent = message;
        };

        const handleCalculation = () => {
            try {
                const dateInput = document.getElementById('birthdate').value;
                if(!dateInput) throw new Error('Selecciona una fecha');
                
                const selectedDate = new Date(dateInput);
                const result = getZodiac(selectedDate);
                
                // Mostrar resultados
                document.getElementById('errorMsg').style.display = 'none';
                document.getElementById('result').style.display = 'block';
                document.getElementById('zodiac-animal').textContent = result.animal;
                document.getElementById('zodiac-chinese').textContent = result.chinese;
                document.getElementById('best-matches').textContent = result.best.join(', ');
                document.getElementById('good-matches').textContent = result.good.join(', ');
                document.getElementById('avoid-matches').textContent = result.avoid.join(', ');
                
                // Advertencia de estimación
                if(!result.exactDate) {
                    showError('Nota: Resultado aproximado usando cálculo estimado');
                }

            } catch(error) {
                showError(`Error: ${error.message}`);
                document.getElementById('result').style.display = 'none';
            }
        };

        // Inicialización
        initializeDatabase();
        document.getElementById('calculateBtn').addEventListener('click', handleCalculation);
    </script>
</body>
</html>
