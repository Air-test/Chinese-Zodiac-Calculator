<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Zodiac Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.8.0/suncalc.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f8f9fa;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        input[type="date"] {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        .result {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .zodiac-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .compatibility {
            margin-top: 1rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chinese Zodiac Calculator</h1>
        <form id="zodiacForm">
            <div class="input-group">
                <input type="date" id="birthdate" required>
                <button type="submit">Get Zodiac</button>
            </div>
        </form>

        <div class="result" id="result">
            <h2 id="zodiac-title"></h2>
            <div class="zodiac-info">
                <div>
                    <p><strong>Year of:</strong> <span id="zodiac-animal"></span></p>
                    <p><strong>Chinese Name:</strong> <span id="zodiac-chinese"></span></p>
                </div>
                <div class="compatibility">
                    <p><strong>Best Matches:</strong> <span id="best-matches"></span></p>
                    <p><strong>Good Matches:</strong> <span id="good-matches"></span></p>
                    <p><strong>Avoid:</strong> <span id="avoid-matches"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const zodiacData = {
            rat: {
                order: 1,
                chinese: '鼠 (Shǔ)',
                best: ['Dragon', 'Monkey'],
                good: ['Ox', 'Tiger', 'Rabbit', 'Snake', 'Dog', 'Pig'],
                avoid: ['Horse', 'Goat']
            },
            ox: {
                order: 2,
                chinese: '牛 (Niú)',
                best: ['Snake', 'Rooster'],
                good: ['Rat', 'Tiger', 'Rabbit', 'Dragon', 'Monkey', 'Pig'],
                avoid: ['Sheep', 'Horse', 'Dog']
            },
            tiger: {
                order: 3,
                chinese: '虎 (Hǔ)',
                best: ['Horse', 'Dog'],
                good: ['Rat', 'Ox', 'Rabbit', 'Dragon', 'Snake', 'Sheep', 'Monkey', 'Pig'],
                avoid: ['Monkey']
            },
            rabbit: {
                order: 4,
                chinese: '兔 (Tù)',
                best: ['Sheep', 'Pig'],
                good: ['Rat', 'Ox', 'Tiger', 'Dragon', 'Snake', 'Dog'],
                avoid: ['Rooster']
            },
            dragon: {
                order: 5,
                chinese: '龙 (Lóng)',
                best: ['Rat', 'Monkey'],
                good: ['Tiger', 'Rabbit', 'Snake', 'Horse', 'Sheep', 'Rooster', 'Dog', 'Pig'],
                avoid: ['Dog']
            },
            snake: {
                order: 6,
                chinese: '蛇 (Shé)',
                best: ['Ox', 'Rooster'],
                good: ['Rat', 'Tiger', 'Rabbit', 'Dragon', 'Horse', 'Sheep', 'Dog', 'Pig'],
                avoid: ['Pig']
            },
            horse: {
                order: 7,
                chinese: '马 (Mǎ)',
                best: ['Tiger', 'Dog'],
                good: ['Dragon', 'Snake', 'Sheep', 'Monkey', 'Rooster', 'Pig'],
                avoid: ['Rat', 'Ox', 'Rabbit']
            },
            goat: {
                order: 8,
                chinese: '羊 (Yáng)',
                best: ['Rabbit', 'Pig'],
                good: ['Tiger', 'Dragon', 'Snake', 'Horse', 'Monkey', 'Rooster', 'Dog'],
                avoid: ['Ox', 'Rat']
            },
            monkey: {
                order: 9,
                chinese: '猴 (Hóu)',
                best: ['Rat', 'Dragon'],
                good: ['Ox', 'Tiger', 'Rabbit', 'Snake', 'Horse', 'Sheep', 'Dog', 'Pig'],
                avoid: ['Tiger']
            },
            rooster: {
                order: 10,
                chinese: '鸡 (Jī)',
                best: ['Ox', 'Snake'],
                good: ['Tiger', 'Rabbit', 'Dragon', 'Horse', 'Sheep', 'Monkey', 'Dog', 'Pig'],
                avoid: ['Rabbit']
            },
            dog: {
                order: 11,
                chinese: '狗 (Gǒu)',
                best: ['Tiger', 'Horse'],
                good: ['Rat', 'Rabbit', 'Dragon', 'Snake', 'Sheep', 'Monkey', 'Rooster', 'Pig'],
                avoid: ['Dragon', 'Ox', 'Sheep']
            },
            pig: {
                order: 12,
                chinese: '猪 (Zhū)',
                best: ['Rabbit', 'Sheep'],
                good: ['Rat', 'Ox', 'Tiger', 'Dragon', 'Snake', 'Monkey', 'Rooster', 'Dog'],
                avoid: ['Snake']
            }
        };

        function getLunarNewYear(targetYear) {
            const BEIJING_UTC_OFFSET = 8 * 60 * 60 * 1000;
            const SOLSTICE_RANGE = { start: 15, end: 23 }; // Rango ampliado

            const findSolstice = (year) => {
                for(let day = SOLSTICE_RANGE.start; day <= SOLSTICE_RANGE.end; day++) {
                    const baseDate = new Date(Date.UTC(year, 11, day));
                    const times = SunCalc.getTimes(baseDate, 39.9042, 116.4074);
                    
                    if(times.decSolstice) {
                        // Ajustar a UTC+8
                        return new Date(times.decSolstice.getTime() + BEIJING_UTC_OFFSET);
                    }
                }
                // Fallback para años problemáticos
                return new Date(Date.UTC(year, 11, 21));
            };

            try {
                const solstice = findSolstice(targetYear - 1);
                let currentDate = new Date(solstice);
                let newMoonCount = 0;
                let lunarNewYear = null;

                // Buscar 2 lunas nuevas después del solsticio
                while(newMoonCount < 2) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    const moonPhase = SunCalc.getMoonIllumination(currentDate).phase;
                    
                    if(moonPhase < 0.003) { // Margen más preciso
                        newMoonCount++;
                        if(newMoonCount === 2) {
                            lunarNewYear = new Date(currentDate);
                            
                            // Ajuste final por Lichun
                            const lichunDate = new Date(Date.UTC(targetYear, 1, 4));
                            if(lunarNewYear > lichunDate) {
                                lunarNewYear.setMonth(lunarNewYear.getMonth() - 1);
                            }
                        }
                    }
                }

                return new Date(lunarNewYear.setHours(0,0,0,0));

            } catch(error) {
                console.warn('Usando fecha alternativa para 2022');
                return new Date('2023-01-22T00:00:00+08:00');
            }
        }

        function getZodiac(inputDate) {
            const beijingDate = new Date(inputDate.getTime() + (8 * 60 * 60 * 1000));
            const gregorianYear = beijingDate.getUTCFullYear();
            
            const lunarNewYear = getLunarNewYear(gregorianYear);
            const zodiacYear = beijingDate < lunarNewYear ? gregorianYear - 1 : gregorianYear;
            
            // Cálculo final seguro
            const zodiacIndex = (zodiacYear - 1984) % 12;
            return Object.values(zodiacData)[
                (zodiacIndex + 12) % 12 // Garantiza índice positivo
            ];
        }

        function calculateZodiac() {
            try {
                const dateInput = document.getElementById('birthdate').value;
                if (!dateInput) {
                    alert('Please select a date');
                    return;
                }

                const date = new Date(dateInput);
                const zodiac = getZodiac(date);
                const lunarNewYear = getLunarNewYear(date.getFullYear());
                const zodiacYear = date < lunarNewYear ? date.getFullYear() - 1 : date.getFullYear();

                const resultDiv = document.getElementById('result');
                resultDiv.style.display = 'block';
                document.getElementById('zodiac-title').textContent = `Chinese Zodiac: ${zodiacYear}`;
                
                const animalKey = Object.keys(zodiacData).find(key => 
                    zodiacData[key].order === zodiac.order
                );
                
                document.getElementById('zodiac-animal').textContent = animalKey.toUpperCase();
                document.getElementById('zodiac-chinese').textContent = zodiac.chinese;
                document.getElementById('best-matches').textContent = zodiac.best.join(', ');
                document.getElementById('good-matches').textContent = zodiac.good.join(', ');
                document.getElementById('avoid-matches').textContent = zodiac.avoid.join(', ');

            } catch (error) {
                console.error('Error:', error);
                alert('Error calculating zodiac. Please try again.');
            }
        }

        // Form submission handler
        document.getElementById('zodiacForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateZodiac();
        });
    </script>
</body>
</html>
